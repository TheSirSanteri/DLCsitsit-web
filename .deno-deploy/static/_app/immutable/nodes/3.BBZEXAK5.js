import"../chunks/DsnmJJEf.js";import{i as $e}from"../chunks/UI-HHCHi.js";import{h as ye,j as Ee,ae as je,af as Ce,ag as De,e as Oe,c as Qe,u as Ge,w as Le,v as Se,p as Ye,U as Je,D as Ze,_ as ze,ac as Be,ah as _e,ai as He,$ as g,a1 as U,ad as X,a2 as q,a3 as Ke,T as c,a as e,m as I,a7 as y,a6 as u,a4 as n,g as Ve,b as p,aj as We,a5 as o,ak as be,a0 as ee,al as Xe}from"../chunks/9i0Um9ta.js";import{i as Z}from"../chunks/COizlyut.js";import{e as qe}from"../chunks/C9PUohD9.js";import{b as et,a as te,n as R,s as he}from"../chunks/CcmC2VZp.js";import{g as tt}from"../chunks/C5Z_5Yfa.js";function rt(re,ae,d){ye&&Ee();var T=re,P=Je,A,v,l=null,O=je()?Ce:De;function z(){A&&Ze(A),l!==null&&(l.lastChild.remove(),T.before(l),l=null),A=v}Oe(()=>{if(O(P,P=ae())){var B=T,H=Se();H&&(l=document.createDocumentFragment(),l.append(B=Qe())),v=Ge(()=>d(B)),H?Le.add_callback(z):z()}}),ye&&(T=Ye)}var at=g('<div class="status svelte-1q7o77e">Loading products…</div>'),st=g('<div class="status error svelte-1q7o77e"><p> </p> <button class="retry svelte-1q7o77e">Retry</button></div>'),it=g('<li class="svelte-1q7o77e"><span class="rname svelte-1q7o77e"> </span> <span class="rqty svelte-1q7o77e"> </span></li>'),ot=g('<aside class="reservation-banner svelte-1q7o77e" role="status" aria-live="polite"><p class="banner-text svelte-1q7o77e">You have succesfully reserved prducts listed below.<br/> <br/> You can change your reservation from down below.</p> <ul class="reslist svelte-1q7o77e" role="list"></ul></aside>'),nt=g('<div class="stat"><span class="label svelte-1q7o77e">Max order:</span> <span class="value svelte-1q7o77e"> </span></div>'),lt=g('<button class="btn minus svelte-1q7o77e" aria-label="Decrease quantity">−</button> <div class="count svelte-1q7o77e" aria-live="polite" aria-atomic="true"> </div> <button class="btn plus svelte-1q7o77e" aria-label="Increase quantity">+</button>',1),ct=g('<li class="card svelte-1q7o77e"><div class="namecol svelte-1q7o77e"><span class="name svelte-1q7o77e"> </span></div> <div class="stats svelte-1q7o77e"><div class="stat"><span class="label svelte-1q7o77e">Available:</span> <span class="value svelte-1q7o77e"> </span></div> <!></div> <div class="price svelte-1q7o77e" aria-label="Price"> </div> <div class="info svelte-1q7o77e" aria-label="Product info"> </div> <div class="qty svelte-1q7o77e" aria-label="Quantity selector"><!></div></li>'),ut=g('<!> <ul class="grid svelte-1q7o77e" role="list"></ul>',1),vt=g('<section class="wrap svelte-1q7o77e" aria-labelledby="productsTitle"><header class="page-head svelte-1q7o77e"><h1 id="productsTitle" class="svelte-1q7o77e">Products</h1></header> <!> <div class="checkout svelte-1q7o77e" role="region" aria-label="Reservation summary"><div class="total svelte-1q7o77e"> </div> <button class="reserve svelte-1q7o77e"> </button></div></section>');function qt(re,ae){ze(ae,!1);let d=I([]),T=I(!0),P=I(""),A=I(0),v=I({}),l=I(null),O=I(0);Be(async()=>{const{token:t}=Ve(et);if(!t){tt("/");return}try{p(d,await te("/api/products",{method:"GET"})),await z()}catch(r){p(P,r.message||"Failed to load products"),R.error(e(P))}finally{p(T,!1)}});async function z(){const t=["/api/me/reservations","/api/me","/api/users/me"];for(const r of t)try{const a=await te(r,{method:"GET"}),i=B(a);i&&(!e(l)||i.reservedAt>e(l).reservedAt)&&p(l,i);const f=H(a);if(Object.keys(f).length){const _=new Set(e(d).map(m=>m.id));for(const[m,x]of Object.entries(f))_.has(m)&&We(v,e(v)[m]=Math.max(0,x|0));return}}catch{}}function B(t){if(t&&Array.isArray(t.reservations)&&t.reservations.length){let r=t.reservations[0];for(const a of t.reservations)(a?.reservedAt??"")>(r?.reservedAt??"")&&(r=a);if(r?.items&&Array.isArray(r.items)){const a=r.items.filter(i=>i?.productId&&Number.isFinite(i?.quantity)).map(i=>({productId:i.productId,quantity:i.quantity}));return{reservedAt:r.reservedAt??"",items:a}}}if(t&&Array.isArray(t.items)){const r=t.items.filter(a=>a?.productId&&Number.isFinite(a?.quantity)).map(a=>({productId:a.productId,quantity:a.quantity}));return{reservedAt:t.reservedAt??"",items:r}}return t&&Array.isArray(t.reservedProducts)?{reservedAt:"",items:t.reservedProducts.filter(a=>a?.productId&&Number.isFinite(a?.quantity)).map(a=>({productId:a.productId,quantity:a.quantity}))}:null}function H(t){const r={};if(t&&Array.isArray(t.items)){for(const a of t.items)a?.productId&&Number.isFinite(a?.quantity)&&(r[a.productId]=a.quantity);return r}if(t&&Array.isArray(t.reservations)&&t.reservations.length){let a=t.reservations[0];for(const i of t.reservations)(i?.reservedAt??"")>(a?.reservedAt??"")&&(a=i);if(a?.items&&Array.isArray(a.items)){for(const i of a.items)i?.productId&&Number.isFinite(i?.quantity)&&(r[i.productId]=i.quantity);return r}}if(t&&Array.isArray(t.reservedProducts)){for(const a of t.reservedProducts)a?.productId&&Number.isFinite(a?.quantity)&&(r[a.productId]=a.quantity);return r}return r}function M(t){return e(v)[t]??0}function de(t){const r=Number.isFinite(t.available)?t.available:0,a=typeof t.maxPerUser=="number"&&t.maxPerUser>0?t.maxPerUser:1/0;return Math.max(0,Math.min(r,a))}function ge(t){const r=M(t.id),a=de(t);r<a&&p(v,{...e(v),[t.id]:r+1})}function Ae(t){const r=M(t.id);r>0&&p(v,{...e(v),[t.id]:r-1})}function xe(){location.reload()}function se(t){return typeof t!="number"||!isFinite(t)?"–":new Intl.NumberFormat("fi-FI",{style:"currency",currency:"EUR"}).format(t)}let Q=I(!1);function Ie(){return e(d).map(t=>({productId:t.id,quantity:M(t.id)})).filter(t=>t.quantity>0)}async function Pe(){if(e(Q))return;const t=Ie();if(t.length===0){R.error("Add items first");return}p(Q,!0);try{const r=await te("/api/products/reserve",{method:"POST",body:JSON.stringify(t)});if(!r.ok){R.error(r.error||"Reservation failed");return}const a=r.message||(r.status==="full"?"Products reserved successfully":"Products reserved partially");if(R.success(a),r.status==="partial"&&r.partials?.length)for(const f of r.partials){const _=e(d).find(m=>m.id===f.productId)?.name??`#${f.productId}`;f.reserved>0?R.info(`Could reserve ${_} only ${f.reserved} (requested ${f.requested})`,6e3):R.error(`Could not reserve ${_} (requested ${f.requested})`,7e3)}const i={};for(const f of r.items)i[f.productId]=f.quantity;p(v,i),p(l,{reservedAt:r.reservedAt,items:r.items}),p(d,await te("/api/products",{method:"GET"}))}catch(r){const a=r.message||"Reservation failed";R.error(a)}finally{p(Q,!1)}}_e(()=>(e(l),e(d)),()=>{p(O,e(l)?e(l).items.reduce((t,r)=>{const a=e(d).find(i=>i.id===r.productId)?.price??0;return t+a*r.quantity},0):0)}),_e(()=>(e(d),e(v)),()=>{p(A,e(d).reduce((t,r)=>{const a=e(v)[r.id]??0,i=Number.isFinite(r.price)?r.price:0;return t+a*i},0))}),He(),$e();var ie=vt(),fe=u(n(ie),2);{var ke=t=>{var r=at();q(t,r)},Fe=t=>{var r=be(),a=ee(r);{var i=_=>{var m=st(),x=n(m),ne=n(x,!0);o(x);var V=u(x,2);o(m),U(()=>y(ne,e(P))),X("click",V,xe),q(_,m)},f=_=>{var m=ut(),x=ee(m);{var ne=k=>{var s=ot(),h=n(s),G=u(n(h),2);Xe(2),o(h);var L=u(h,2);qe(L,5,()=>(e(l),c(()=>e(l).items)),F=>F.productId,(F,b)=>{var $=be(),W=ee($);{var le=S=>{var Y=it(),w=n(Y),ce=n(w,!0);o(w);var E=u(w,2),ue=n(E);o(E),o(Y),U(j=>{y(ce,j),y(ue,`× ${e(b),c(()=>e(b).quantity)??""}`)},[()=>(e(d),e(b),c(()=>e(d).find(j=>j.id===e(b).productId)?.name??e(b).productId))]),q(S,Y)};Z(W,S=>{e(b),c(()=>e(b).quantity>0)&&S(le)})}q(F,$)}),o(L),o(s),U(F=>y(G,` Remember to pay ${F??""} (ticket to inside included) to already given payment information.`),[()=>(e(O),c(()=>se(e(O))))]),q(k,s)};Z(x,k=>{e(l),c(()=>e(l)&&e(l).items?.length)&&k(ne)})}var V=u(x,2);qe(V,5,()=>e(d),k=>k.id,(k,s)=>{var h=ct(),G=n(h),L=n(G),F=n(L,!0);o(L),o(G);var b=u(G,2),$=n(b),W=u(n($),2),le=n(W,!0);o(W),o($);var S=u($,2);{var Y=N=>{var C=nt(),D=u(n(C),2),J=n(D,!0);o(D),o(C),U(ve=>y(J,ve),[()=>(e(s),c(()=>Number.isFinite(e(s).maxPerUser)?e(s).maxPerUser:"∞"))]),q(N,C)};Z(S,N=>{e(s),c(()=>typeof e(s).maxPerUser=="number"&&e(s).maxPerUser>0)&&N(Y)})}o(b);var w=u(b,2),ce=n(w,!0);o(w);var E=u(w,2),ue=n(E,!0);o(E);var j=u(E,2),Ue=n(j);rt(Ue,()=>(e(v),e(s),c(()=>e(v)[e(s).id])),N=>{var C=lt(),D=ee(C),J=u(D,2),ve=n(J,!0);o(J);var pe=u(J,2);U((Re,Te,Me)=>{D.disabled=Re,y(ve,Te),pe.disabled=Me},[()=>(e(s),c(()=>M(e(s).id)<=0)),()=>(e(s),c(()=>M(e(s).id))),()=>(e(s),c(()=>M(e(s).id)>=de(e(s))))]),X("click",D,()=>Ae(e(s))),X("click",pe,()=>ge(e(s))),q(N,C)}),o(j),o(h),U(N=>{he(h,"title",(e(s),c(()=>e(s).name))),he(h,"aria-label",(e(s),c(()=>e(s).name))),y(F,(e(s),c(()=>e(s).name))),y(le,(e(s),c(()=>e(s).available??0))),y(ce,N),y(ue,(e(s),c(()=>e(s).info||"")))},[()=>(e(s),c(()=>se(e(s).price)))]),q(k,h)}),o(V),q(_,m)};Z(a,_=>{e(P)?_(i):_(f,!1)},!0)}q(t,r)};Z(fe,t=>{e(T)?t(ke):t(Fe,!1)})}var me=u(fe,2),oe=n(me),we=n(oe,!0);o(oe);var K=u(oe,2),Ne=n(K,!0);o(K),o(me),o(ie),U(t=>{y(we,t),K.disabled=e(Q)||e(A)<=0,y(Ne,e(Q)?"Reserving…":"Reserve products")},[()=>(e(A),c(()=>se(e(A))))]),X("click",K,Pe),q(re,ie),Ke()}export{qt as component};
